<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cherry Blossom Boat ðŸŒ¸</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<style>
  :root {
    --bg1: #ffe4ec;
    --bg2: #ffd6f0;
    --accent1: #ff7aa2;
    --accent2: #ff5e78;
    --text: #4a2c2a;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{background:linear-gradient(135deg,var(--bg1),var(--bg2));font-family:'Segoe UI',sans-serif;overflow:hidden;color:var(--text);}
  .center{position:fixed;inset:0;display:flex;justify-content:center;align-items:center;padding:18px;}
  .card{background:rgba(255,255,255,0.85);padding:16px;border-radius:12px;width:min(1000px,95vw);box-shadow:0 8px 20px rgba(0,0,0,0.15);}
  h1{margin-bottom:8px;color:var(--accent2);}
  .row{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px;}
  input,button{padding:10px;border-radius:10px;border:none;outline:none;font-size:15px;}
  .btn{background:linear-gradient(45deg,var(--accent1),var(--accent2));color:white;cursor:pointer;font-weight:800;}
  .btn-ghost{background:rgba(255,255,255,0.7);border:1px solid rgba(0,0,0,0.1);cursor:pointer;}
  .rooms{display:flex;flex-direction:column;gap:8px;max-height:220px;overflow:auto;}
  .room{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:10px;background:rgba(255,255,255,0.5);}
  .game{display:none;position:fixed;inset:0;}
  #gameCanvas{display:block;width:100%;height:100%;background:#87CEEB;}
  .ui{position:absolute;left:14px;top:14px;z-index:5;text-shadow:1px 1px 3px rgba(255,255,255,0.7);}
  .controls{position:absolute;left:14px;bottom:14px;z-index:5;text-shadow:1px 1px 3px rgba(255,255,255,0.7);}
  .top-right{position:absolute;top:14px;right:14px;display:flex;gap:8px;z-index:5;}
</style>
</head>
<body>
<div id="menu" class="center">
  <div class="card">
    <h1>ðŸŒ¸ Cherry Blossom Boat</h1>
    <div class="row">
      <input id="playerName" placeholder="Your Name">
      <button class="btn" id="createBtn">Create Room</button>
    </div>
    <div id="statusBar">Connecting...</div>
    <div class="rooms" id="roomsList"></div>
  </div>
</div>

<div id="game" class="game">
  <canvas id="gameCanvas"></canvas>
  <div class="ui"><h2 id="roomInfo"></h2></div>
  <div class="controls">WASD / Arrow Keys to move ðŸŒ¸</div>
  <div class="top-right"><button id="leaveBtn" class="btn-ghost">Leave</button></div>
</div>

<script>
  // ---------- Supabase setup ----------
  const SUPABASE_URL = "https://chumxrvwpxmxttbbvemp.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNodW14cnZ3cHhteHR0YmJ2ZW1wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4OTIxMjcsImV4cCI6MjA3MTQ2ODEyN30.__GvVFs6SwJVKLUuz6Y7aA8R5wxDWlBeA8qhKpQrCbc";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const menu = document.getElementById("menu");
  const gameDiv = document.getElementById("game");
  const canvas = document.getElementById("gameCanvas");
  const ctx = canvas.getContext("2d");
  const statusBar = document.getElementById("statusBar");
  const roomsList = document.getElementById("roomsList");
  const roomInfo = document.getElementById("roomInfo");

  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;

  let currentRoom = null;
  let player = {id:null,name:"",x:100,y:100};
  let worldMap=[]; 
  let keys={};

  // ---------- Input ----------
  window.onkeydown=e=>keys[e.key.toLowerCase()]=true;
  window.onkeyup=e=>keys[e.key.toLowerCase()]=false;

  // ---------- Create Room ----------
  document.getElementById("createBtn").onclick=async()=>{
    const name=document.getElementById("playerName").value.trim()||"Anon";
    player.name=name;
    const map=generateMap(20,20);
    const {data,error}=await supabase.from("rooms").insert([{map}]).select().single();
    if(error){statusBar.textContent="Error:"+error.message;return;}
    joinRoom(data.id);
  };

  // ---------- Join Room ----------
  async function joinRoom(roomId){
    currentRoom=roomId;
    const {data,error}=await supabase.from("players").insert([{room_id:roomId,name:player.name,x:100,y:100}]).select().single();
    if(error){statusBar.textContent="Join error:"+error.message;return;}
    player.id=data.id;
    startGame();
  }

  document.getElementById("leaveBtn").onclick=async()=>{
    if(player.id) await supabase.from("players").delete().eq("id",player.id);
    location.reload();
  }

  async function loadRooms(){
    const {data,error}=await supabase.from("rooms").select("*").limit(5);
    roomsList.innerHTML="";
    if(data){
      data.forEach(r=>{
        const div=document.createElement("div");
        div.className="room";
        div.innerHTML=`<span>Room ${r.id}</span><button class="btn-ghost">Join</button>`;
        div.querySelector("button").onclick=()=>joinRoom(r.id);
        roomsList.appendChild(div);
      });
    }
  }
  setInterval(loadRooms,2000);
  loadRooms();

  // ---------- Map ----------
  function generateMap(w,h){
    let m=[];
    for(let y=0;y<h;y++){
      let row=[];
      for(let x=0;x<w;x++){
        let r=Math.random();
        if(r<0.1) row.push("water");
        else if(r<0.2) row.push("sand");
        else if(r<0.7) row.push("grass");
        else row.push("stone");
      }
      m.push(row);
    }
    return m;
  }

  // ---------- Game Loop ----------
  async function gameLoop(){
    if(keys["w"]||keys["arrowup"]) player.y-=2;
    if(keys["s"]||keys["arrowdown"]) player.y+=2;
    if(keys["a"]||keys["arrowleft"]) player.x-=2;
    if(keys["d"]||keys["arrowright"]) player.x+=2;

    if(player.id){
      await supabase.from("players").update({x:player.x,y:player.y}).eq("id",player.id);
    }

    const {data:players}=await supabase.from("players").select("*").eq("room_id",currentRoom);

    ctx.clearRect(0,0,canvas.width,canvas.height);
    drawMap();
    if(players){
      players.forEach(p=>{
        ctx.fillStyle=p.id===player.id?"red":"blue";
        ctx.beginPath();
        ctx.arc(p.x,p.y,10,0,Math.PI*2);
        ctx.fill();
        ctx.fillStyle="#000";
        ctx.fillText(p.name,p.x-10,p.y-15);
      });
    }
    requestAnimationFrame(gameLoop);
  }

  function drawMap(){
    if(!worldMap.length) return;
    const tile=32;
    for(let y=0;y<worldMap.length;y++){
      for(let x=0;x<worldMap[y].length;x++){
        const type=worldMap[y][x];
        if(type==="grass") ctx.fillStyle="#77dd77";
        else if(type==="water") ctx.fillStyle="#4da6ff";
        else if(type==="sand") ctx.fillStyle="#fff5ba";
        else ctx.fillStyle="#bbb";
        ctx.fillRect(x*tile,y*tile,tile,tile);
      }
    }
  }

  async function startGame(){
    menu.style.display="none";
    gameDiv.style.display="block";
    roomInfo.textContent="Room "+currentRoom;

    const {data,error}=await supabase.from("rooms").select("map").eq("id",currentRoom).single();
    if(error){statusBar.textContent="Error loading map";return;}
    worldMap=data.map;

    requestAnimationFrame(gameLoop);
  }
</script>
</body>
</html>
