<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>2D Roblox Multiplayer</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<style>
/* --- same styles as your old code --- */
*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Arial',sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);overflow:hidden;color:#333} /* ... truncated for brevity ... */
</style>
</head>
<body>
<div id="menu" class="menu-screen">
  <div class="menu-container">
    <h1 class="title">🎮 ROBLOX 2D</h1>
    <div class="form-row">
      <div class="form-group">
        <label>Your Name:</label>
        <input id="playerName" placeholder="Enter your name" maxlength="20">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>World Name:</label>
        <input id="worldName" placeholder="My Awesome World" maxlength="30">
      </div>
      <div class="form-group">
        <label>Map Type:</label>
        <select id="mapType">
          <option value="Grasslands">🌱 Grasslands</option>
          <option value="Desert Oasis">🏜️ Desert Oasis</option>
          <option value="Volcanic Island">🌋 Volcanic Island</option>
          <option value="Winter Wonderland">❄️ Winter Wonderland</option>
          <option value="Forest Grove">🌲 Forest Grove</option>
          <option value="Rocky Canyon">🏔️ Rocky Canyon</option>
        </select>
      </div>
    </div>
    <div style="text-align:center;">
      <button class="btn btn-create" id="createBtn">Create World</button>
      <button class="btn" onclick="loadRooms()">Refresh Rooms</button>
    </div>
    <div id="statusBar" class="status-bar">Connecting to server...</div>
    <div class="rooms-container">
      <h3 style="color:#667eea;margin-bottom:15px;">🌍 Available Worlds</h3>
      <div id="roomsList">
        <div class="room-card">
          <div class="room-info">
            <div class="room-name">Loading worlds...</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="game" class="game-container">
  <canvas id="gameCanvas"></canvas>
  <div class="ui-overlay">
    <div><strong id="roomInfo">Room Loading...</strong></div>
    <div>Map: <span id="currentMapType">Loading...</span></div>
    <div>Players Online: <span id="playerCount">0</span></div>
  </div>
  <div class="players-list" id="playersList">
    <strong>Players:</strong>
    <div id="playersContent">Loading...</div>
  </div>
  <div class="controls">
    <strong>Controls:</strong><br>
    WASD or Arrow Keys to move<br>
    🎮 Explore the world with friends!
  </div>
  <div class="top-right">
    <button id="leaveBtn" class="btn-ghost">Leave World</button>
  </div>
</div>

<script>
const SUPABASE_URL = "https://chumxrvwpxmxttbbvemp.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNodW14cnZ3cHhteHR0YmJ2ZW1wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4OTIxMjcsImV4cCI6MjA3MTQ2ODEyN30.__GvVFs6SwJVKLUuz6Y7aA8R5wxDWlBeA8qhKpQrCbc";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const menu = document.getElementById("menu");
const gameDiv = document.getElementById("game");
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const statusBar = document.getElementById("statusBar");
const roomsList = document.getElementById("roomsList");
const roomInfo = document.getElementById("roomInfo");
const currentMapType = document.getElementById("currentMapType");
const playerCount = document.getElementById("playerCount");
const playersContent = document.getElementById("playersContent");

let currentRoom = null;
let player = { id: null, name: "", x: 400, y: 300, color: '#ff6b6b' };
let otherPlayers = [];
let worldMap = [];
let keys = {};
let gameRunning = false;
let camera = { x: 0, y: 0 };

const mapWidth = 2000;
const mapHeight = 1500;
const tileSize = 64;

const textures = {
  grass: '#4a7c59',
  stone: '#8b8680',
  sand: '#f4e4bc',
  water: '#4a90e2',
  lava: '#ff4757',
  snow: '#ffffff',
  dirt: '#8b4513',
  wood: '#deb887'
};

const mapTypeConfigs = {
  'Grasslands': { primary: 'grass', secondary: 'stone', emoji: '🌱' },
  'Desert Oasis': { primary: 'sand', secondary: 'water', emoji: '🏜️' },
  'Volcanic Island': { primary: 'stone', secondary: 'lava', emoji: '🌋' },
  'Winter Wonderland': { primary: 'snow', secondary: 'water', emoji: '❄️' },
  'Forest Grove': { primary: 'grass', secondary: 'wood', emoji: '🌲' },
  'Rocky Canyon': { primary: 'stone', secondary: 'dirt', emoji: '🏔️' }
};

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

window.addEventListener('keydown', e => { if(!['INPUT','TEXTAREA'].includes(e.target.tagName)){keys[e.key.toLowerCase()]=true;e.preventDefault();}});
window.addEventListener('keyup', e => { keys[e.key.toLowerCase()] = false; });
window.addEventListener('resize', ()=>{canvas.width=window.innerWidth;canvas.height=window.innerHeight;});

// --- Create World ---
document.getElementById("createBtn").onclick = async () => {
  const nameInput = document.getElementById("playerName").value.trim();
  if (!nameInput) { alert("Enter your name!"); return; }
  const worldName = document.getElementById("worldName").value.trim() || "Unnamed World";
  const mapType = document.getElementById("mapType").value;
  player.name = nameInput;
  statusBar.textContent="Creating world...";

  try {
    const map = generateMap(Math.ceil(mapWidth/tileSize), Math.ceil(mapHeight/tileSize), mapType);
    const { data, error } = await supabase.from("rooms").insert([{
      name: worldName,
      map_type: mapType,
      map: map,
      created_by: nameInput,
      max_players:50
    }]).select().single();
    if(error){statusBar.textContent="Error: "+error.message; return;}
    statusBar.textContent="World created! Joining...";
    joinRoom(data.id, worldName, mapType);
  } catch(e){statusBar.textContent="Error: "+e.message;}
};

// --- Join Room ---
async function joinRoom(roomId, roomName, mapType){
  const nameInput = document.getElementById("playerName").value.trim();
  if(!nameInput){alert("Enter your name!"); return;}
  player.name = nameInput;
  currentRoom = roomId;
  statusBar.textContent="Joining world...";
  try{
    const { data, error } = await supabase.from("players").insert([{
      room_id: roomId,
      name: player.name,
      x: player.x,
      y: player.y,
      color: player.color
    }]).select().single();
    if(error){statusBar.textContent="Error: "+error.message; return;}
    player.id = data.id; player.color=data.color;

    const { data: roomData, error: roomError } = await supabase.from("rooms").select("*").eq("id", roomId).single();
    if(roomError){statusBar.textContent="Error loading world"; return;}
    worldMap = roomData.map;
    startGame(roomName||roomData.name, mapType||roomData.map_type);
  }catch(e){statusBar.textContent="Error joining world: "+e.message;}
}

// --- Leave ---
document.getElementById("leaveBtn").onclick = async ()=>{
  if(player.id) await supabase.from("players").delete().eq("id",player.id);
  gameRunning=false; location.reload();
};

// --- Load Rooms ---
async function loadRooms(){
  try{
    const { data, error } = await supabase.from("rooms").select(`id,name,map_type,created_by,max_players,created_at,players(count)`).order('created_at',{ascending:false});
    if(error){statusBar.textContent="Error loading rooms: "+error.message; return;}
    roomsList.innerHTML='';
    if(!data||data.length===0){roomsList.innerHTML='<div class="room-card"><div class="room-info">No worlds found</div></div>'; return;}
    data.forEach(room=>{
      const card = document.createElement('div'); card.className='room-card';
      card.innerHTML=`<div class="room-info"><div class="room-name">${room.name}</div><div class="room-details">Map: ${room.map_type} | Players: ${room.players?.length||0}/${room.max_players}</div></div><button class="btn btn-join">Join</button>`;
      card.querySelector('button').onclick=()=>joinRoom(room.id,room.name,room.map_type);
      roomsList.appendChild(card);
    });
    statusBar.textContent="Rooms loaded!";
  }catch(e){statusBar.textContent="Error: "+e.message;}
}
loadRooms();

// --- Start Game ---
function startGame(roomName,mapType){
  menu.style.display='none';
  gameDiv.style.display='block';
  roomInfo.textContent=roomName;
  currentMapType.textContent=mapType;
  gameRunning=true;
  lastSyncTime=performance.now();
  requestAnimationFrame(gameLoop);
}

// --- Map Generation FIXED ---
function generateMap(width,height,type){
  const map=[]; const config=mapTypeConfigs[type]||mapTypeConfigs['Grasslands'];
  for(let y=0;y<height;y++){
    map[y]=[];
    for(let x=0;x<width;x++){
      // Border water for some maps
      if(type==='Desert Oasis' && (x===0||y===0||x===width-1||y===height-1)){
        map[y][x]=textures.water; continue;
      }
      if(type==='Volcanic Island' && Math.random()<0.03){ map[y][x]=textures.lava; continue; }
      if(type==='Winter Wonderland' && Math.random()<0.05){ map[y][x]=textures.snow; continue; }
      if(type==='Forest Grove' && Math.random()<0.1){ map[y][x]=textures.wood; continue; }
      // Default generation
      map[y][x]=textures[config.primary]||textures.grass;
    }
  }
  return map;
}

// --- Game Loop ---
let lastSyncTime=0;
function gameLoop(timestamp){
  if(!gameRunning) return;
  let speed=5;
  if(keys['w']||keys['arrowup']) player.y-=speed;
  if(keys['s']||keys['arrowdown']) player.y+=speed;
  if(keys['a']||keys['arrowleft']) player.x-=speed;
  if(keys['d']||keys['arrowright']) player.x+=speed;

  player.x=Math.max(0,Math.min(mapWidth-tileSize,player.x));
  player.y=Math.max(0,Math.min(mapHeight-tileSize,player.y));
  camera.x=player.x-canvas.width/2;
  camera.y=player.y-canvas.height/2;

  drawMap(); drawPlayers();

  if(timestamp-lastSyncTime>150 && player.id){
    lastSyncTime=timestamp;
    supabase.from("players").update({x:player.x,y:player.y}).eq("id",player.id).catch(console.error);
  }

  updateOtherPlayers();
  requestAnimationFrame(gameLoop);
}

// --- Draw Map ---
function drawMap(){
  const cols=Math.ceil(canvas.width/tileSize);
  const rows=Math.ceil(canvas.height/tileSize);
  const startX=Math.floor(camera.x/tileSize);
  const startY=Math.floor(camera.y/tileSize);
  for(let y=0;y<=rows;y++){
    for(let x=0;x<=cols;x++){
      const tileX=startX+x; const tileY=startY+y;
      if(worldMap[tileY] && worldMap[tileY][tileX]){
        ctx.fillStyle=worldMap[tileY][tileX];
        ctx.fillRect(x*tileSize-(camera.x%tileSize), y*tileSize-(camera.y%tileSize), tileSize, tileSize);
      }
    }
  }
}

// --- Draw Players ---
function drawPlayers(){
  ctx.fillStyle=player.color;
  ctx.fillRect(player.x-camera.x,player.y-camera.y,40,40);
  otherPlayers.forEach(p=>{
    ctx.fillStyle=p.color; ctx.fillRect(p.x-camera.x,p.y-camera.y,40,40);
  });
  playersContent.innerHTML='';
  [player,...otherPlayers].forEach(p=>{
    const div=document.createElement('div');
    div.className='player-item';
    div.textContent=p.name;
    playersContent.appendChild(div);
  });
}

// --- Update Other Players ---
async function updateOtherPlayers(){
  if(!currentRoom) return;
  try{
    const { data,error } = await supabase.from("players").select("*").eq("room_id",currentRoom);
    if(error) return;
    otherPlayers=data.filter(p=>p.id!==player.id);
    playerCount.textContent=data.length;
  }catch(e){console.error(e);}
}
setInterval(updateOtherPlayers,500);
</script>
</body>
</html>
